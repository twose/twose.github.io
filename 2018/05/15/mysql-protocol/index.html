<!DOCTYPE html>
<html>
<head>
    

    

    



    <meta charset="utf-8">
    
    
    
    <title>[整理] MySQL协议分析 | TWO SEE | SEE is the sea of cc</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="mysql">
    <meta name="description" content="目录[TOC] 1 交互过程MySQL客户端与服务器的交互主要分为两个阶段：握手认证阶段和命令执行阶段。 1.1 握手认证阶段握手认证阶段为客户端与服务器建立连接后进行，交互过程如下：  服务器 -&amp;gt; 客户端：握手初始化消息 客户端 -&amp;gt; 服务器：登陆认证消息 服务器 -&amp;gt; 客户端：认证结果消息  1.2 命令执行阶段客户端认证成功后，会进入命令执行阶段，交互过程如下：  客户端">
<meta name="keywords" content="mysql">
<meta property="og:type" content="article">
<meta property="og:title" content="[整理] MySQL协议分析">
<meta property="og:url" content="http://www.twosee.cn/2018/05/15/mysql-protocol/index.html">
<meta property="og:site_name" content="TWO SEE">
<meta property="og:description" content="目录[TOC] 1 交互过程MySQL客户端与服务器的交互主要分为两个阶段：握手认证阶段和命令执行阶段。 1.1 握手认证阶段握手认证阶段为客户端与服务器建立连接后进行，交互过程如下：  服务器 -&amp;gt; 客户端：握手初始化消息 客户端 -&amp;gt; 服务器：登陆认证消息 服务器 -&amp;gt; 客户端：认证结果消息  1.2 命令执行阶段客户端认证成功后，会进入命令执行阶段，交互过程如下：  客户端">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://hutaow.com/images/articles/201311/mysql_protocol_message.png">
<meta property="og:image" content="http://hutaow.com/images/articles/201311/mysql_protocol_struct.png">
<meta property="og:image" content="http://hutaow.com/images/articles/201311/mysql_protocol_handshake.png">
<meta property="og:image" content="http://hutaow.com/images/articles/201311/mysql_protocol_auth_40.png">
<meta property="og:image" content="http://hutaow.com/images/articles/201311/mysql_protocol_auth_41.png">
<meta property="og:image" content="http://hutaow.com/images/articles/201311/mysql_protocol_command.png">
<meta property="og:updated_time" content="2018-05-15T08:14:14.861Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="[整理] MySQL协议分析">
<meta name="twitter:description" content="目录[TOC] 1 交互过程MySQL客户端与服务器的交互主要分为两个阶段：握手认证阶段和命令执行阶段。 1.1 握手认证阶段握手认证阶段为客户端与服务器建立连接后进行，交互过程如下：  服务器 -&amp;gt; 客户端：握手初始化消息 客户端 -&amp;gt; 服务器：登陆认证消息 服务器 -&amp;gt; 客户端：认证结果消息  1.2 命令执行阶段客户端认证成功后，会进入命令执行阶段，交互过程如下：  客户端">
<meta name="twitter:image" content="http://hutaow.com/images/articles/201311/mysql_protocol_message.png">
    
        <link rel="alternate" type="application/atom+xml" title="TWO SEE" href="/atom.xml">
    
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="/css/style.css?v=1.7.1">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="https://avatars2.githubusercontent.com/u/25978241?s=460&v=4">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">Twosee</h5>
          <a href="mailto:twose@qq.com" title="twose@qq.com" class="mail">twose@qq.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                文章
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                标签
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                分类
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/twose" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="http://www.weibo.com/twoseee" target="_blank" >
                <i class="icon icon-lg icon-weibo"></i>
                Weibo
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">[整理] MySQL协议分析</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="検索">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">[整理] MySQL协议分析</h1>
        <h5 class="subtitle">
            
                <time datetime="2018-05-15T08:05:26.000Z" itemprop="datePublished" class="page-time">
  2018-05-15
</time>


            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#目录"><span class="post-toc-number">1.</span> <span class="post-toc-text">目录</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#1-交互过程"><span class="post-toc-number">2.</span> <span class="post-toc-text">1 交互过程</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-1-握手认证阶段"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">1.1 握手认证阶段</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-2-命令执行阶段"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">1.2 命令执行阶段</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#2-基本类型"><span class="post-toc-number">3.</span> <span class="post-toc-text">2 基本类型</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-1-整型值"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">2.1 整型值</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-2-字符串（以NULL结尾）（Null-Terminated-String）"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">2.2 字符串（以NULL结尾）（Null-Terminated String）</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-3-二进制数据（长度编码）（Length-Coded-Binary）"><span class="post-toc-number">3.3.</span> <span class="post-toc-text">2.3 二进制数据（长度编码）（Length Coded Binary）</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-4-字符串（长度编码）（Length-Coded-String）"><span class="post-toc-number">3.4.</span> <span class="post-toc-text">2.4 字符串（长度编码）（Length Coded String）</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#3-报文结构"><span class="post-toc-number">4.</span> <span class="post-toc-text">3 报文结构</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-1-消息头"><span class="post-toc-number">4.1.</span> <span class="post-toc-text">3.1 消息头</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#3-1-1-报文长度"><span class="post-toc-number">4.1.1.</span> <span class="post-toc-text">3.1.1 报文长度</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#3-1-2-序号"><span class="post-toc-number">4.1.2.</span> <span class="post-toc-text">3.1.2 序号</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-2-消息体"><span class="post-toc-number">4.2.</span> <span class="post-toc-text">3.2 消息体</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#4-报文类型"><span class="post-toc-number">5.</span> <span class="post-toc-text">4 报文类型</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#4-1-登陆认证交互报文"><span class="post-toc-number">5.1.</span> <span class="post-toc-text">4.1 登陆认证交互报文</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-1-1-握手初始化报文（服务器-gt-客户端）"><span class="post-toc-number">5.1.1.</span> <span class="post-toc-text">4.1.1 握手初始化报文（服务器 -&gt; 客户端）</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-1-2-登陆认证报文（客户端-gt-服务器）"><span class="post-toc-number">5.1.2.</span> <span class="post-toc-text">4.1.2 登陆认证报文（客户端 -&gt; 服务器）</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#4-2-客户端命令请求报文（客户端-gt-服务器）"><span class="post-toc-number">5.2.</span> <span class="post-toc-text">4.2 客户端命令请求报文（客户端 -&gt; 服务器）</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-2-1-COM-QUIT-消息报文"><span class="post-toc-number">5.2.1.</span> <span class="post-toc-text">4.2.1 COM_QUIT 消息报文</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-2-2-COM-INIT-DB-消息报文"><span class="post-toc-number">5.2.2.</span> <span class="post-toc-text">4.2.2 COM_INIT_DB 消息报文</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-2-3-COM-QUERY-消息报文"><span class="post-toc-number">5.2.3.</span> <span class="post-toc-text">4.2.3 COM_QUERY 消息报文</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-2-4-COM-FIELD-LIST-消息报文"><span class="post-toc-number">5.2.4.</span> <span class="post-toc-text">4.2.4 COM_FIELD_LIST 消息报文</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-2-5-COM-CREATE-DB-消息报文"><span class="post-toc-number">5.2.5.</span> <span class="post-toc-text">4.2.5 COM_CREATE_DB 消息报文</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-2-6-COM-DROP-DB-消息报文"><span class="post-toc-number">5.2.6.</span> <span class="post-toc-text">4.2.6 COM_DROP_DB 消息报文</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-2-7-COM-REFRESH-消息报文"><span class="post-toc-number">5.2.7.</span> <span class="post-toc-text">4.2.7 COM_REFRESH 消息报文</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-2-8-COM-SHUTDOWN-消息报文"><span class="post-toc-number">5.2.8.</span> <span class="post-toc-text">4.2.8 COM_SHUTDOWN 消息报文</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-2-9-COM-STATISTICS-消息报文"><span class="post-toc-number">5.2.9.</span> <span class="post-toc-text">4.2.9 COM_STATISTICS 消息报文</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-2-10-COM-PROCESS-INFO-消息报文"><span class="post-toc-number">5.2.10.</span> <span class="post-toc-text">4.2.10 COM_PROCESS_INFO 消息报文</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-2-11-COM-PROCESS-KILL-消息报文"><span class="post-toc-number">5.2.11.</span> <span class="post-toc-text">4.2.11 COM_PROCESS_KILL 消息报文</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-2-12-COM-DEBUG-消息报文"><span class="post-toc-number">5.2.12.</span> <span class="post-toc-text">4.2.12 COM_DEBUG 消息报文</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-2-13-COM-PING-消息报文"><span class="post-toc-number">5.2.13.</span> <span class="post-toc-text">4.2.13 COM_PING 消息报文</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-2-14-COM-CHANGE-USER-消息报文"><span class="post-toc-number">5.2.14.</span> <span class="post-toc-text">4.2.14 COM_CHANGE_USER 消息报文</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-2-15-COM-BINLOG-DUMP-消息报文"><span class="post-toc-number">5.2.15.</span> <span class="post-toc-text">4.2.15 COM_BINLOG_DUMP 消息报文</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-2-16-COM-TABLE-DUMP-消息报文"><span class="post-toc-number">5.2.16.</span> <span class="post-toc-text">4.2.16 COM_TABLE_DUMP 消息报文</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-2-17-COM-REGISTER-SLAVE-消息报文"><span class="post-toc-number">5.2.17.</span> <span class="post-toc-text">4.2.17 COM_REGISTER_SLAVE 消息报文</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-2-18-COM-PREPARE-消息报文"><span class="post-toc-number">5.2.18.</span> <span class="post-toc-text">4.2.18 COM_PREPARE 消息报文</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-2-19-COM-EXECUTE-消息报文"><span class="post-toc-number">5.2.19.</span> <span class="post-toc-text">4.2.19 COM_EXECUTE 消息报文</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-2-20-COM-LONG-DATA-消息报文"><span class="post-toc-number">5.2.20.</span> <span class="post-toc-text">4.2.20 COM_LONG_DATA 消息报文</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-2-21-COM-CLOSE-STMT-消息报文"><span class="post-toc-number">5.2.21.</span> <span class="post-toc-text">4.2.21 COM_CLOSE_STMT 消息报文</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-2-22-COM-RESET-STMT-消息报文"><span class="post-toc-number">5.2.22.</span> <span class="post-toc-text">4.2.22 COM_RESET_STMT 消息报文</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-2-23-COM-SET-OPTION-消息报文"><span class="post-toc-number">5.2.23.</span> <span class="post-toc-text">4.2.23 COM_SET_OPTION 消息报文</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-2-24-COM-FETCH-STMT-消息报文"><span class="post-toc-number">5.2.24.</span> <span class="post-toc-text">4.2.24 COM_FETCH_STMT 消息报文</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#4-3-服务器响应报文（服务器-gt-客户端）"><span class="post-toc-number">5.3.</span> <span class="post-toc-text">4.3 服务器响应报文（服务器 -&gt; 客户端）</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-3-1-OK-响应报文"><span class="post-toc-number">5.3.1.</span> <span class="post-toc-text">4.3.1 OK 响应报文</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-3-2-Error-响应报文"><span class="post-toc-number">5.3.2.</span> <span class="post-toc-text">4.3.2 Error 响应报文</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-3-3-Result-Set-消息"><span class="post-toc-number">5.3.3.</span> <span class="post-toc-text">4.3.3 Result Set 消息</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-3-4-Result-Set-Header-结构"><span class="post-toc-number">5.3.4.</span> <span class="post-toc-text">4.3.4 Result Set Header 结构</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-3-5-Field-结构"><span class="post-toc-number">5.3.5.</span> <span class="post-toc-text">4.3.5 Field 结构</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-3-6-EOF-结构"><span class="post-toc-number">5.3.6.</span> <span class="post-toc-text">4.3.6 EOF 结构</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-3-7-Row-Data-结构"><span class="post-toc-number">5.3.7.</span> <span class="post-toc-text">4.3.7 Row Data 结构</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-3-8-Row-Data-结构（二进制数据）"><span class="post-toc-number">5.3.8.</span> <span class="post-toc-text">4.3.8 Row Data 结构（二进制数据）</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-3-9-PREPARE-OK-响应报文（Prepared-Statement）"><span class="post-toc-number">5.3.9.</span> <span class="post-toc-text">4.3.9 PREPARE_OK 响应报文（Prepared Statement）</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-3-10-Parameter-响应报文（Prepared-Statement）"><span class="post-toc-number">5.3.10.</span> <span class="post-toc-text">4.3.10 Parameter 响应报文（Prepared Statement）</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#5-参考资料"><span class="post-toc-number">6.</span> <span class="post-toc-text">5 参考资料</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#来源"><span class="post-toc-number">7.</span> <span class="post-toc-text">来源</span></a></li></ol>
        </nav>
    </aside>
    
<article id="post-mysql-protocol"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">[整理] MySQL协议分析</h1>
        <div class="post-meta">
            <time class="post-time" title="2018-05-15 16:05:26" datetime="2018-05-15T08:05:26.000Z"  itemprop="datePublished">2018-05-15</time>

            


            
<span id="busuanzi_container_page_pv" title="文章总阅读量" style='display:none'>
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><p>[TOC]</p>
<h2 id="1-交互过程"><a href="#1-交互过程" class="headerlink" title="1 交互过程"></a>1 交互过程</h2><p>MySQL客户端与服务器的交互主要分为两个阶段：握手认证阶段和命令执行阶段。</p>
<h3 id="1-1-握手认证阶段"><a href="#1-1-握手认证阶段" class="headerlink" title="1.1 握手认证阶段"></a>1.1 握手认证阶段</h3><p>握手认证阶段为客户端与服务器建立连接后进行，交互过程如下：</p>
<ul>
<li>服务器 -&gt; 客户端：握手初始化消息</li>
<li>客户端 -&gt; 服务器：登陆认证消息</li>
<li>服务器 -&gt; 客户端：认证结果消息</li>
</ul>
<h3 id="1-2-命令执行阶段"><a href="#1-2-命令执行阶段" class="headerlink" title="1.2 命令执行阶段"></a>1.2 命令执行阶段</h3><p>客户端认证成功后，会进入命令执行阶段，交互过程如下：</p>
<ul>
<li>客户端 -&gt; 服务器：执行命令消息</li>
<li>服务器 -&gt; 客户端：命令执行结果</li>
</ul>
<a id="more"></a>
<p><strong>MySQL客户端与服务器的完整交互过程如下</strong>：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="http://hutaow.com/images/articles/201311/mysql_protocol_message.png" alt="MySQL客户端与服务器交互示意图" title="">
                </div>
                <div class="image-caption">MySQL客户端与服务器交互示意图</div>
            </figure>
<h2 id="2-基本类型"><a href="#2-基本类型" class="headerlink" title="2 基本类型"></a>2 基本类型</h2><h3 id="2-1-整型值"><a href="#2-1-整型值" class="headerlink" title="2.1 整型值"></a>2.1 整型值</h3><p>MySQL报文中整型值分别有1、2、3、4、8字节长度，使用小字节序传输。</p>
<h3 id="2-2-字符串（以NULL结尾）（Null-Terminated-String）"><a href="#2-2-字符串（以NULL结尾）（Null-Terminated-String）" class="headerlink" title="2.2 字符串（以NULL结尾）（Null-Terminated String）"></a>2.2 字符串（以NULL结尾）（Null-Terminated String）</h3><p>字符串长度不固定，当遇到’NULL’（0x00）字符时结束。</p>
<h3 id="2-3-二进制数据（长度编码）（Length-Coded-Binary）"><a href="#2-3-二进制数据（长度编码）（Length-Coded-Binary）" class="headerlink" title="2.3 二进制数据（长度编码）（Length Coded Binary）"></a>2.3 二进制数据（长度编码）（Length Coded Binary）</h3><p>数据长度不固定，长度值由数据前的1-9个字节决定，其中长度值所占的字节数不定，字节数由第1个字节决定，如下表：</p>
<table>
<thead>
<tr>
<th>第一个字节值</th>
<th>后续字节数</th>
<th>长度值说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>0-250</td>
<td>0</td>
<td>第一个字节值即为数据的真实长度</td>
</tr>
<tr>
<td>251</td>
<td>0</td>
<td>空数据，数据的真实长度为零</td>
</tr>
<tr>
<td>252</td>
<td>2</td>
<td>后续额外2个字节标识了数据的真实长度</td>
</tr>
<tr>
<td>253</td>
<td>3</td>
<td>后续额外3个字节标识了数据的真实长度</td>
</tr>
<tr>
<td>254</td>
<td>8</td>
<td>后续额外8个字节标识了数据的真实长度</td>
</tr>
</tbody>
</table>
<h3 id="2-4-字符串（长度编码）（Length-Coded-String）"><a href="#2-4-字符串（长度编码）（Length-Coded-String）" class="headerlink" title="2.4 字符串（长度编码）（Length Coded String）"></a>2.4 字符串（长度编码）（Length Coded String）</h3><p>字符串长度不固定，无’NULL’（0x00）结束符，编码方式与上面的 Length Coded Binary 相同。</p>
<h2 id="3-报文结构"><a href="#3-报文结构" class="headerlink" title="3 报文结构"></a>3 报文结构</h2><p>报文分为消息头和消息体两部分，其中消息头占用固定的4个字节，消息体长度由消息头中的长度字段决定，报文结构如下：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="http://hutaow.com/images/articles/201311/mysql_protocol_struct.png" alt="MySQL报文结构" title="">
                </div>
                <div class="image-caption">MySQL报文结构</div>
            </figure>
<h3 id="3-1-消息头"><a href="#3-1-消息头" class="headerlink" title="3.1 消息头"></a>3.1 消息头</h3><h4 id="3-1-1-报文长度"><a href="#3-1-1-报文长度" class="headerlink" title="3.1.1 报文长度"></a>3.1.1 报文长度</h4><p>用于标记当前请求消息的实际数据长度值，以字节为单位，占用3个字节，最大值为 0xFFFFFF，即接近 16 MB 大小（比16MB少1个字节）。</p>
<h4 id="3-1-2-序号"><a href="#3-1-2-序号" class="headerlink" title="3.1.2 序号"></a>3.1.2 序号</h4><p>在一次完整的请求/响应交互过程中，用于保证消息顺序的正确，每次客户端发起请求时，序号值都会从0开始计算。</p>
<h3 id="3-2-消息体"><a href="#3-2-消息体" class="headerlink" title="3.2 消息体"></a>3.2 消息体</h3><p>消息体用于存放请求的内容及响应的数据，长度由消息头中的长度值决定。</p>
<h2 id="4-报文类型"><a href="#4-报文类型" class="headerlink" title="4 报文类型"></a>4 报文类型</h2><h3 id="4-1-登陆认证交互报文"><a href="#4-1-登陆认证交互报文" class="headerlink" title="4.1 登陆认证交互报文"></a>4.1 登陆认证交互报文</h3><h4 id="4-1-1-握手初始化报文（服务器-gt-客户端）"><a href="#4-1-1-握手初始化报文（服务器-gt-客户端）" class="headerlink" title="4.1.1 握手初始化报文（服务器 -&gt; 客户端）"></a>4.1.1 握手初始化报文（服务器 -&gt; 客户端）</h4><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="http://hutaow.com/images/articles/201311/mysql_protocol_handshake.png" alt="MySQL握手初始化报文" title="">
                </div>
                <div class="image-caption">MySQL握手初始化报文</div>
            </figure>
<p><strong>服务协议版本号</strong>：该值由 PROTOCOL_VERSION 宏定义决定（参考MySQL源代码<code>/include/mysql_version.h</code>头文件定义）</p>
<p><strong>服务版本信息</strong>：该值为字符串，由 MYSQL_SERVER_VERSION 宏定义决定（参考MySQL源代码<code>/include/mysql_version.h</code>头文件定义）</p>
<p><strong>服务器线程ID</strong>：服务器为当前连接所创建的线程ID。</p>
<p><strong>挑战随机数</strong>：MySQL数据库用户认证采用的是挑战/应答的方式，服务器生成该挑战数并发送给客户端，由客户端进行处理并返回相应结果，然后服务器检查是否与预期的结果相同，从而完成用户认证的过程。</p>
<p><strong>服务器权能标志</strong>：用于与客户端协商通讯方式，各标志位含义如下（参考MySQL源代码<code>/include/mysql_com.h</code>中的宏定义）：</p>
<table>
<thead>
<tr>
<th>标志位名称</th>
<th>标志位</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>CLIENT_LONG_PASSWORD</td>
<td>0x0001</td>
<td>new more secure passwords</td>
</tr>
<tr>
<td>CLIENT_FOUND_ROWS</td>
<td>0x0002</td>
<td>Found instead of affected rows</td>
</tr>
<tr>
<td>CLIENT_LONG_FLAG</td>
<td>0x0004</td>
<td>Get all column flags</td>
</tr>
<tr>
<td>CLIENT_CONNECT_WITH_DB</td>
<td>0x0008</td>
<td>One can specify db on connect</td>
</tr>
<tr>
<td>CLIENT_NO_SCHEMA</td>
<td>0x0010</td>
<td>Do not allow database.table.column</td>
</tr>
<tr>
<td>CLIENT_COMPRESS</td>
<td>0x0020</td>
<td>Can use compression protocol</td>
</tr>
<tr>
<td>CLIENT_ODBC</td>
<td>0x0040</td>
<td>Odbc client</td>
</tr>
<tr>
<td>CLIENT_LOCAL_FILES</td>
<td>0x0080</td>
<td>Can use LOAD DATA LOCAL</td>
</tr>
<tr>
<td>CLIENT_IGNORE_SPACE</td>
<td>0x0100</td>
<td>Ignore spaces before ‘(‘</td>
</tr>
<tr>
<td>CLIENT_PROTOCOL_41</td>
<td>0x0200</td>
<td>New 4.1 protocol</td>
</tr>
<tr>
<td>CLIENT_INTERACTIVE</td>
<td>0x0400</td>
<td>This is an interactive client</td>
</tr>
<tr>
<td>CLIENT_SSL</td>
<td>0x0800</td>
<td>Switch to SSL after handshake</td>
</tr>
<tr>
<td>CLIENT_IGNORE_SIGPIPE</td>
<td>0x1000</td>
<td>IGNORE sigpipes</td>
</tr>
<tr>
<td>CLIENT_TRANSACTIONS</td>
<td>0x2000</td>
<td>Client knows about transactions</td>
</tr>
<tr>
<td>CLIENT_RESERVED</td>
<td>0x4000</td>
<td>Old flag for 4.1 protocol</td>
</tr>
<tr>
<td>CLIENT_SECURE_CONNECTION</td>
<td>0x8000</td>
<td>New 4.1 authentication</td>
</tr>
<tr>
<td>CLIENT_MULTI_STATEMENTS</td>
<td>0x0001 0000</td>
<td>Enable/disable multi-stmt support</td>
</tr>
<tr>
<td>CLIENT_MULTI_RESULTS</td>
<td>0x0002 0000</td>
<td>Enable/disable multi-results</td>
</tr>
</tbody>
</table>
<p><strong>字符编码</strong>：标识服务器所使用的字符集。</p>
<p><strong>服务器状态</strong>：状态值定义如下（参考MySQL源代码<code>/include/mysql_com.h</code>中的宏定义）：</p>
<table>
<thead>
<tr>
<th>状态名称</th>
<th>状态值</th>
</tr>
</thead>
<tbody>
<tr>
<td>SERVER_STATUS_IN_TRANS</td>
<td>0x0001</td>
</tr>
<tr>
<td>SERVER_STATUS_AUTOCOMMIT</td>
<td>0x0002</td>
</tr>
<tr>
<td>SERVER_STATUS_CURSOR_EXISTS</td>
<td>0x0040</td>
</tr>
<tr>
<td>SERVER_STATUS_LAST_ROW_SENT</td>
<td>0x0080</td>
</tr>
<tr>
<td>SERVER_STATUS_DB_DROPPED</td>
<td>0x0100</td>
</tr>
<tr>
<td>SERVER_STATUS_NO_BACKSLASH_ESCAPES</td>
<td>0x0200</td>
</tr>
<tr>
<td>SERVER_STATUS_METADATA_CHANGED</td>
<td>0x0400</td>
</tr>
</tbody>
</table>
<h4 id="4-1-2-登陆认证报文（客户端-gt-服务器）"><a href="#4-1-2-登陆认证报文（客户端-gt-服务器）" class="headerlink" title="4.1.2 登陆认证报文（客户端 -&gt; 服务器）"></a>4.1.2 登陆认证报文（客户端 -&gt; 服务器）</h4><p><strong>MySQL 4.0 及之前的版本</strong></p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="http://hutaow.com/images/articles/201311/mysql_protocol_auth_40.png" alt="MySQL登陆认证报文(4.0及之前的版本)" title="">
                </div>
                <div class="image-caption">MySQL登陆认证报文(4.0及之前的版本)</div>
            </figure>
<p><strong>MySQL 4.1 及之后的版本</strong></p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="http://hutaow.com/images/articles/201311/mysql_protocol_auth_41.png" alt="MySQL登陆认证报文(4.1及之后的版本)" title="">
                </div>
                <div class="image-caption">MySQL登陆认证报文(4.1及之后的版本)</div>
            </figure>
<p><strong>客户端权能标志</strong>：用于与客户端协商通讯方式，标志位含义与握手初始化报文中的相同。客户端收到服务器发来的初始化报文后，会对服务器发送的权能标志进行修改，保留自身所支持的功能，然后将权能标返回给服务器，从而保证服务器与客户端通讯的兼容性。</p>
<p><strong>最大消息长度</strong>：客户端发送请求报文时所支持的最大消息长度值。</p>
<p><strong>字符编码</strong>：标识通讯过程中使用的字符编码，与服务器在认证初始化报文中发送的相同。</p>
<p><strong>用户名</strong>：客户端登陆用户的用户名称。</p>
<p><strong>挑战认证数据</strong>：客户端用户密码使用服务器发送的挑战随机数进行加密后，生成挑战认证数据，然后返回给服务器，用于对用户身份的认证。</p>
<p><strong>数据库名称</strong>：当客户端的权能标志位 CLIENT_CONNECT_WITH_DB 被置位时，该字段必须出现。</p>
<h3 id="4-2-客户端命令请求报文（客户端-gt-服务器）"><a href="#4-2-客户端命令请求报文（客户端-gt-服务器）" class="headerlink" title="4.2 客户端命令请求报文（客户端 -&gt; 服务器）"></a>4.2 客户端命令请求报文（客户端 -&gt; 服务器）</h3><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="http://hutaow.com/images/articles/201311/mysql_protocol_command.png" alt="MySQL客户端命令请求报文" title="">
                </div>
                <div class="image-caption">MySQL客户端命令请求报文</div>
            </figure>
<p><strong>命令</strong>：用于标识当前请求消息的类型，例如切换数据库（0x02）、查询命令（0x03）等。命令值的取值范围及说明如下表（参考MySQL源代码<code>/include/mysql_com.h</code>头文件中的定义）：</p>
<table>
<thead>
<tr>
<th>类型值</th>
<th>命令</th>
<th>功能</th>
<th>关联函数</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x00</td>
<td>COM_SLEEP</td>
<td>（内部线程状态）</td>
<td>（无）</td>
</tr>
<tr>
<td>0x01</td>
<td>COM_QUIT</td>
<td>关闭连接</td>
<td>mysql_close</td>
</tr>
<tr>
<td>0x02</td>
<td>COM_INIT_DB</td>
<td>切换数据库</td>
<td>mysql_select_db</td>
</tr>
<tr>
<td>0x03</td>
<td>COM_QUERY</td>
<td>SQL查询请求</td>
<td>mysql_real_query</td>
</tr>
<tr>
<td>0x04</td>
<td>COM_FIELD_LIST</td>
<td>获取数据表字段信息</td>
<td>mysql_list_fields</td>
</tr>
<tr>
<td>0x05</td>
<td>COM_CREATE_DB</td>
<td>创建数据库</td>
<td>mysql_create_db</td>
</tr>
<tr>
<td>0x06</td>
<td>COM_DROP_DB</td>
<td>删除数据库</td>
<td>mysql_drop_db</td>
</tr>
<tr>
<td>0x07</td>
<td>COM_REFRESH</td>
<td>清除缓存</td>
<td>mysql_refresh</td>
</tr>
<tr>
<td>0x08</td>
<td>COM_SHUTDOWN</td>
<td>停止服务器</td>
<td>mysql_shutdown</td>
</tr>
<tr>
<td>0x09</td>
<td>COM_STATISTICS</td>
<td>获取服务器统计信息</td>
<td>mysql_stat</td>
</tr>
<tr>
<td>0x0A</td>
<td>COM_PROCESS_INFO</td>
<td>获取当前连接的列表</td>
<td>mysql_list_processes</td>
</tr>
<tr>
<td>0x0B</td>
<td>COM_CONNECT</td>
<td>（内部线程状态）</td>
<td>（无）</td>
</tr>
<tr>
<td>0x0C</td>
<td>COM_PROCESS_KILL</td>
<td>中断某个连接</td>
<td>mysql_kill</td>
</tr>
<tr>
<td>0x0D</td>
<td>COM_DEBUG</td>
<td>保存服务器调试信息</td>
<td>mysql_dump_debug_info</td>
</tr>
<tr>
<td>0x0E</td>
<td>COM_PING</td>
<td>测试连通性</td>
<td>mysql_ping</td>
</tr>
<tr>
<td>0x0F</td>
<td>COM_TIME</td>
<td>（内部线程状态）</td>
<td>（无）</td>
</tr>
<tr>
<td>0x10</td>
<td>COM_DELAYED_INSERT</td>
<td>（内部线程状态）</td>
<td>（无）</td>
</tr>
<tr>
<td>0x11</td>
<td>COM_CHANGE_USER</td>
<td>重新登陆（不断连接）</td>
<td>mysql_change_user</td>
</tr>
<tr>
<td>0x12</td>
<td>COM_BINLOG_DUMP</td>
<td>获取二进制日志信息</td>
<td>（无）</td>
</tr>
<tr>
<td>0x13</td>
<td>COM_TABLE_DUMP</td>
<td>获取数据表结构信息</td>
<td>（无）</td>
</tr>
<tr>
<td>0x14</td>
<td>COM_CONNECT_OUT</td>
<td>（内部线程状态）</td>
<td>（无）</td>
</tr>
<tr>
<td>0x15</td>
<td>COM_REGISTER_SLAVE</td>
<td>从服务器向主服务器进行注册</td>
<td>（无）</td>
</tr>
<tr>
<td>0x16</td>
<td>COM_STMT_PREPARE</td>
<td>预处理SQL语句</td>
<td>mysql_stmt_prepare</td>
</tr>
<tr>
<td>0x17</td>
<td>COM_STMT_EXECUTE</td>
<td>执行预处理语句</td>
<td>mysql_stmt_execute</td>
</tr>
<tr>
<td>0x18</td>
<td>COM_STMT_SEND_LONG_DATA</td>
<td>发送BLOB类型的数据</td>
<td>mysql_stmt_send_long_data</td>
</tr>
<tr>
<td>0x19</td>
<td>COM_STMT_CLOSE</td>
<td>销毁预处理语句</td>
<td>mysql_stmt_close</td>
</tr>
<tr>
<td>0x1A</td>
<td>COM_STMT_RESET</td>
<td>清除预处理语句参数缓存</td>
<td>mysql_stmt_reset</td>
</tr>
<tr>
<td>0x1B</td>
<td>COM_SET_OPTION</td>
<td>设置语句选项</td>
<td>mysql_set_server_option</td>
</tr>
<tr>
<td>0x1C</td>
<td>COM_STMT_FETCH</td>
<td>获取预处理语句的执行结果</td>
<td>mysql_stmt_fetch</td>
</tr>
</tbody>
</table>
<p><strong>参数</strong>：内容是用户在MySQL客户端输入的命令（不包括每行命令结尾的”;”分号）。另外这个字段的字符串不是以NULL字符结尾，而是通过消息头中的长度值计算而来。</p>
<p>例如：当我们在MySQL客户端中执行<code>use hutaow;</code>命令时（切换到<code>hutaow</code>数据库），发送的请求报文数据会是下面的样子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x02 0x68 0x75 0x74 0x61 0x6f 0x77</span><br></pre></td></tr></table></figure>
<p>其中，<code>0x02</code>为请求类型值<code>COM_INIT_DB</code>，后面的<code>0x68 0x75 0x74 0x61 0x6f 0x77</code>为ASCII字符<code>hutaow</code>。</p>
<h4 id="4-2-1-COM-QUIT-消息报文"><a href="#4-2-1-COM-QUIT-消息报文" class="headerlink" title="4.2.1 COM_QUIT 消息报文"></a>4.2.1 COM_QUIT 消息报文</h4><p><strong>功能</strong>：关闭当前连接（客户端退出），无参数。</p>
<h4 id="4-2-2-COM-INIT-DB-消息报文"><a href="#4-2-2-COM-INIT-DB-消息报文" class="headerlink" title="4.2.2 COM_INIT_DB 消息报文"></a>4.2.2 COM_INIT_DB 消息报文</h4><p><strong>功能</strong>：切换数据库，对应的SQL语句为<code>USE &lt;database&gt;</code>。</p>
<table>
<thead>
<tr>
<th>字节</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>n</td>
<td>数据库名称（字符串到达消息尾部时结束，无结束符）</td>
</tr>
</tbody>
</table>
<h4 id="4-2-3-COM-QUERY-消息报文"><a href="#4-2-3-COM-QUERY-消息报文" class="headerlink" title="4.2.3 COM_QUERY 消息报文"></a>4.2.3 COM_QUERY 消息报文</h4><p><strong>功能</strong>：最常见的请求消息类型，当用户执行SQL语句时发送该消息。</p>
<table>
<thead>
<tr>
<th>字节</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>n</td>
<td>SQL语句（字符串到达消息尾部时结束，无结束符）</td>
</tr>
</tbody>
</table>
<h4 id="4-2-4-COM-FIELD-LIST-消息报文"><a href="#4-2-4-COM-FIELD-LIST-消息报文" class="headerlink" title="4.2.4 COM_FIELD_LIST 消息报文"></a>4.2.4 COM_FIELD_LIST 消息报文</h4><p><strong>功能</strong>：查询某表的字段（列）信息，等同于SQL语句<code>SHOW [FULL] FIELDS FROM ...</code>。</p>
<table>
<thead>
<tr>
<th>字节</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>n</td>
<td>表格名称（Null-Terminated String）</td>
</tr>
<tr>
<td>n</td>
<td>字段（列）名称或通配符（可选）</td>
</tr>
</tbody>
</table>
<h4 id="4-2-5-COM-CREATE-DB-消息报文"><a href="#4-2-5-COM-CREATE-DB-消息报文" class="headerlink" title="4.2.5 COM_CREATE_DB 消息报文"></a>4.2.5 COM_CREATE_DB 消息报文</h4><p><strong>功能</strong>：创建数据库，该消息已过时，而被SQL语句<code>CREATE DATABASE</code>代替。</p>
<table>
<thead>
<tr>
<th>字节</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>n</td>
<td>数据库名称（字符串到达消息尾部时结束，无结束符）</td>
</tr>
</tbody>
</table>
<h4 id="4-2-6-COM-DROP-DB-消息报文"><a href="#4-2-6-COM-DROP-DB-消息报文" class="headerlink" title="4.2.6 COM_DROP_DB 消息报文"></a>4.2.6 COM_DROP_DB 消息报文</h4><p><strong>功能</strong>：删除数据库，该消息已过时，而被SQL语句<code>DROP DATABASE</code>代替。</p>
<table>
<thead>
<tr>
<th>字节</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>n</td>
<td>数据库名称（字符串到达消息尾部时结束，无结束符）</td>
</tr>
</tbody>
</table>
<h4 id="4-2-7-COM-REFRESH-消息报文"><a href="#4-2-7-COM-REFRESH-消息报文" class="headerlink" title="4.2.7 COM_REFRESH 消息报文"></a>4.2.7 COM_REFRESH 消息报文</h4><p><strong>功能</strong>：清除缓存，等同于SQL语句<code>FLUSH</code>，或是执行<code>mysqladmin flush-foo</code>命令时发送该消息。</p>
<table>
<thead>
<tr>
<th>字节</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>清除缓存选项（位图方式存储，各标志位含义如下）</td>
</tr>
<tr>
<td></td>
<td>0x01: REFRESH_GRANT</td>
</tr>
<tr>
<td></td>
<td>0x02: REFRESH_LOG</td>
</tr>
<tr>
<td></td>
<td>0x04: REFRESH_TABLES</td>
</tr>
<tr>
<td></td>
<td>0x08: REFRESH_HOSTS</td>
</tr>
<tr>
<td></td>
<td>0x10: REFRESH_STATUS</td>
</tr>
<tr>
<td></td>
<td>0x20: REFRESH_THREADS</td>
</tr>
<tr>
<td></td>
<td>0x40: REFRESH_SLAVE</td>
</tr>
<tr>
<td></td>
<td>0x80: REFRESH_MASTER</td>
</tr>
</tbody>
</table>
<h4 id="4-2-8-COM-SHUTDOWN-消息报文"><a href="#4-2-8-COM-SHUTDOWN-消息报文" class="headerlink" title="4.2.8 COM_SHUTDOWN 消息报文"></a>4.2.8 COM_SHUTDOWN 消息报文</h4><p><strong>功能</strong>：停止MySQL服务。执行<code>mysqladmin shutdown</code>命令时发送该消息。</p>
<table>
<thead>
<tr>
<th>字节</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>停止服务选项</td>
</tr>
<tr>
<td></td>
<td>0x00: SHUTDOWN_DEFAULT</td>
</tr>
<tr>
<td></td>
<td>0x01: SHUTDOWN_WAIT_CONNECTIONS</td>
</tr>
<tr>
<td></td>
<td>0x02: SHUTDOWN_WAIT_TRANSACTIONS</td>
</tr>
<tr>
<td></td>
<td>0x08: SHUTDOWN_WAIT_UPDATES</td>
</tr>
<tr>
<td></td>
<td>0x10: SHUTDOWN_WAIT_ALL_BUFFERS</td>
</tr>
<tr>
<td></td>
<td>0x11: SHUTDOWN_WAIT_CRITICAL_BUFFERS</td>
</tr>
<tr>
<td></td>
<td>0xFE: KILL_QUERY</td>
</tr>
<tr>
<td></td>
<td>0xFF: KILL_CONNECTION</td>
</tr>
</tbody>
</table>
<h4 id="4-2-9-COM-STATISTICS-消息报文"><a href="#4-2-9-COM-STATISTICS-消息报文" class="headerlink" title="4.2.9 COM_STATISTICS 消息报文"></a>4.2.9 COM_STATISTICS 消息报文</h4><p><strong>功能</strong>：查看MySQL服务的统计信息（例如运行时间、每秒查询次数等）。执行<code>mysqladmin status</code>命令时发送该消息，无参数。</p>
<h4 id="4-2-10-COM-PROCESS-INFO-消息报文"><a href="#4-2-10-COM-PROCESS-INFO-消息报文" class="headerlink" title="4.2.10 COM_PROCESS_INFO 消息报文"></a>4.2.10 COM_PROCESS_INFO 消息报文</h4><p><strong>功能</strong>：获取当前活动的线程（连接）列表。等同于SQL语句<code>SHOW PROCESSLIST</code>，或是执行<code>mysqladmin processlist</code>命令时发送该消息，无参数。</p>
<h4 id="4-2-11-COM-PROCESS-KILL-消息报文"><a href="#4-2-11-COM-PROCESS-KILL-消息报文" class="headerlink" title="4.2.11 COM_PROCESS_KILL 消息报文"></a>4.2.11 COM_PROCESS_KILL 消息报文</h4><p><strong>功能</strong>：要求服务器中断某个连接。等同于SQL语句<code>KILL &lt;id&gt;</code>。</p>
<table>
<thead>
<tr>
<th>字节</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>4</td>
<td>连接ID号（小字节序）</td>
</tr>
</tbody>
</table>
<h4 id="4-2-12-COM-DEBUG-消息报文"><a href="#4-2-12-COM-DEBUG-消息报文" class="headerlink" title="4.2.12 COM_DEBUG 消息报文"></a>4.2.12 COM_DEBUG 消息报文</h4><p><strong>功能</strong>：要求服务器将调试信息保存下来，保存的信息多少依赖于编译选项设置（debug=no|yes|full）。执行<code>mysqladmin debug</code>命令时发送该消息，无参数。</p>
<h4 id="4-2-13-COM-PING-消息报文"><a href="#4-2-13-COM-PING-消息报文" class="headerlink" title="4.2.13 COM_PING 消息报文"></a>4.2.13 COM_PING 消息报文</h4><p><strong>功能</strong>：该消息用来测试连通性，同时会将服务器的无效连接（超时）计数器清零。执行<code>mysqladmin ping</code>命令时发送该消息，无参数。</p>
<h4 id="4-2-14-COM-CHANGE-USER-消息报文"><a href="#4-2-14-COM-CHANGE-USER-消息报文" class="headerlink" title="4.2.14 COM_CHANGE_USER 消息报文"></a>4.2.14 COM_CHANGE_USER 消息报文</h4><p><strong>功能</strong>：在不断连接的情况下重新登陆，该操作会销毁MySQL服务器端的会话上下文（包括临时表、会话变量等）。有些连接池用这种方法实现清除会话上下文。</p>
<table>
<thead>
<tr>
<th>字节</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>n</td>
<td>用户名（字符串以NULL结尾）</td>
</tr>
<tr>
<td>n</td>
<td>密码（挑战数）</td>
</tr>
<tr>
<td></td>
<td>MySQL 3.23 版本：Null-Terminated String（长度9字节）</td>
</tr>
<tr>
<td></td>
<td>MySQL 4.1 版本：Length Coded String（长度1+21字节）</td>
</tr>
<tr>
<td>n</td>
<td>数据库名称（Null-Terminated String）</td>
</tr>
<tr>
<td>2</td>
<td>字符编码</td>
</tr>
</tbody>
</table>
<h4 id="4-2-15-COM-BINLOG-DUMP-消息报文"><a href="#4-2-15-COM-BINLOG-DUMP-消息报文" class="headerlink" title="4.2.15 COM_BINLOG_DUMP 消息报文"></a>4.2.15 COM_BINLOG_DUMP 消息报文</h4><p><strong>功能</strong>：该消息是备份连接时由从服务器向主服务器发送的最后一个请求，主服务器收到后，会响应一系列的报文，每个报文都包含一个二进制日志事件。如果主服务器出现故障时，会发送一个EOF报文。</p>
<table>
<thead>
<tr>
<th>字节</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>4</td>
<td>二进制日志数据的起始位置（小字节序）</td>
</tr>
<tr>
<td>4</td>
<td>二进制日志数据标志位（目前未使用，永远为0x00）</td>
</tr>
<tr>
<td>4</td>
<td>从服务器的服务器ID值（小字节序）</td>
</tr>
<tr>
<td>n</td>
<td>二进制日志的文件名称（可选，默认值为主服务器上第一个有效的文件名）</td>
</tr>
</tbody>
</table>
<h4 id="4-2-16-COM-TABLE-DUMP-消息报文"><a href="#4-2-16-COM-TABLE-DUMP-消息报文" class="headerlink" title="4.2.16 COM_TABLE_DUMP 消息报文"></a>4.2.16 COM_TABLE_DUMP 消息报文</h4><p><strong>功能</strong>：将数据表从主服务器复制到从服务器中，执行SQL语句<code>LOAD TABLE ... FROM MASTER</code>时发送该消息。目前该消息已过时，不再使用。</p>
<table>
<thead>
<tr>
<th>字节</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>n</td>
<td>数据库名称（Length Coded String）</td>
</tr>
<tr>
<td>n</td>
<td>数据表名称（Length Coded String）</td>
</tr>
</tbody>
</table>
<h4 id="4-2-17-COM-REGISTER-SLAVE-消息报文"><a href="#4-2-17-COM-REGISTER-SLAVE-消息报文" class="headerlink" title="4.2.17 COM_REGISTER_SLAVE 消息报文"></a>4.2.17 COM_REGISTER_SLAVE 消息报文</h4><p><strong>功能</strong>：在从服务器<code>report_host</code>变量设置的情况下，当备份连接时向主服务器发送的注册消息。</p>
<table>
<thead>
<tr>
<th>字节</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>4</td>
<td>从服务器ID值（小字节序）</td>
</tr>
<tr>
<td>n</td>
<td>主服务器IP地址（Length Coded String）</td>
</tr>
<tr>
<td>n</td>
<td>主服务器用户名（Length Coded String）</td>
</tr>
<tr>
<td>n</td>
<td>主服务器密码（Length Coded String）</td>
</tr>
<tr>
<td>2</td>
<td>主服务器端口号</td>
</tr>
<tr>
<td>4</td>
<td>安全备份级别（由MySQL服务器<code>rpl_recovery_rank</code>变量设置，暂时未使用）</td>
</tr>
<tr>
<td>4</td>
<td>主服务器ID值（值恒为0x00）</td>
</tr>
</tbody>
</table>
<h4 id="4-2-18-COM-PREPARE-消息报文"><a href="#4-2-18-COM-PREPARE-消息报文" class="headerlink" title="4.2.18 COM_PREPARE 消息报文"></a>4.2.18 COM_PREPARE 消息报文</h4><p><strong>功能</strong>：预处理SQL语句，使用带有”?”占位符的SQL语句时发送该消息。</p>
<table>
<thead>
<tr>
<th>字节</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>n</td>
<td>带有”?”占位符的SQL语句（字符串到达消息尾部时结束，无结束符）</td>
</tr>
</tbody>
</table>
<h4 id="4-2-19-COM-EXECUTE-消息报文"><a href="#4-2-19-COM-EXECUTE-消息报文" class="headerlink" title="4.2.19 COM_EXECUTE 消息报文"></a>4.2.19 COM_EXECUTE 消息报文</h4><p><strong>功能</strong>：执行预处理语句。</p>
<table>
<thead>
<tr>
<th>字节</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>4</td>
<td>预处理语句的ID值</td>
</tr>
<tr>
<td>1</td>
<td>标志位</td>
</tr>
<tr>
<td></td>
<td>0x00: CURSOR_TYPE_NO_CURSOR</td>
</tr>
<tr>
<td></td>
<td>0x01: CURSOR_TYPE_READ_ONLY</td>
</tr>
<tr>
<td></td>
<td>0x02: CURSOR_TYPE_FOR_UPDATE</td>
</tr>
<tr>
<td></td>
<td>0x04: CURSOR_TYPE_SCROLLABLE</td>
</tr>
<tr>
<td>4</td>
<td>保留（值恒为0x01）</td>
</tr>
<tr>
<td>如果参数数量大于0</td>
<td></td>
</tr>
<tr>
<td>n</td>
<td>空位图（Null-Bitmap，长度 = (参数数量 + 7) / 8 字节）</td>
</tr>
<tr>
<td>1</td>
<td>参数分隔标志</td>
</tr>
<tr>
<td>如果参数分隔标志值为1</td>
<td></td>
</tr>
<tr>
<td>n</td>
<td>每个参数的类型值（长度 = 参数数量 * 2 字节）</td>
</tr>
<tr>
<td>n</td>
<td>每个参数的值</td>
</tr>
</tbody>
</table>
<h4 id="4-2-20-COM-LONG-DATA-消息报文"><a href="#4-2-20-COM-LONG-DATA-消息报文" class="headerlink" title="4.2.20 COM_LONG_DATA 消息报文"></a>4.2.20 COM_LONG_DATA 消息报文</h4><p>该消息报文有两种形式，一种用于发送二进制数据，另一种用于发送文本数据。</p>
<p><strong>功能</strong>：用于发送二进制（BLOB）类型的数据（调用<code>mysql_stmt_send_long_data</code>函数）。</p>
<table>
<thead>
<tr>
<th>字节</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>4</td>
<td>预处理语句的ID值（小字节序）</td>
</tr>
<tr>
<td>2</td>
<td>参数序号（小字节序）</td>
</tr>
<tr>
<td>n</td>
<td>数据负载（数据到达消息尾部时结束，无结束符）</td>
</tr>
</tbody>
</table>
<p><strong>功能</strong>：用于发送超长字符串类型的数据（调用<code>mysql_send_long_data</code>函数）</p>
<table>
<thead>
<tr>
<th>字节</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>4</td>
<td>预处理语句的ID值（小字节序）</td>
</tr>
<tr>
<td>2</td>
<td>参数序号（小字节序）</td>
</tr>
<tr>
<td>2</td>
<td>数据类型（未使用）</td>
</tr>
<tr>
<td>n</td>
<td>数据负载（数据到达消息尾部时结束，无结束符）</td>
</tr>
</tbody>
</table>
<h4 id="4-2-21-COM-CLOSE-STMT-消息报文"><a href="#4-2-21-COM-CLOSE-STMT-消息报文" class="headerlink" title="4.2.21 COM_CLOSE_STMT 消息报文"></a>4.2.21 COM_CLOSE_STMT 消息报文</h4><p><strong>功能</strong>：销毁预处理语句。</p>
<table>
<thead>
<tr>
<th>字节</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>4</td>
<td>预处理语句的ID值（小字节序）</td>
</tr>
</tbody>
</table>
<h4 id="4-2-22-COM-RESET-STMT-消息报文"><a href="#4-2-22-COM-RESET-STMT-消息报文" class="headerlink" title="4.2.22 COM_RESET_STMT 消息报文"></a>4.2.22 COM_RESET_STMT 消息报文</h4><p><strong>功能</strong>：将预处理语句的参数缓存清空。多数情况和<code>COM_LONG_DATA</code>一起使用。</p>
<table>
<thead>
<tr>
<th>字节</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>4</td>
<td>预处理语句的ID值（小字节序）</td>
</tr>
</tbody>
</table>
<h4 id="4-2-23-COM-SET-OPTION-消息报文"><a href="#4-2-23-COM-SET-OPTION-消息报文" class="headerlink" title="4.2.23 COM_SET_OPTION 消息报文"></a>4.2.23 COM_SET_OPTION 消息报文</h4><p><strong>功能</strong>：设置语句选项，选项值为<code>/include/mysql_com.h</code>头文件中定义的<code>enum_mysql_set_option</code>枚举类型：</p>
<ul>
<li>MYSQL_OPTION_MULTI_STATEMENTS_ON</li>
<li>MYSQL_OPTION_MULTI_STATEMENTS_OFF</li>
</ul>
<table>
<thead>
<tr>
<th>字节</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>2</td>
<td>选项值（小字节序）</td>
</tr>
</tbody>
</table>
<h4 id="4-2-24-COM-FETCH-STMT-消息报文"><a href="#4-2-24-COM-FETCH-STMT-消息报文" class="headerlink" title="4.2.24 COM_FETCH_STMT 消息报文"></a>4.2.24 COM_FETCH_STMT 消息报文</h4><p><strong>功能</strong>：获取预处理语句的执行结果（一次可以获取多行数据）。</p>
<table>
<thead>
<tr>
<th>字节</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>4</td>
<td>预处理语句的ID值（小字节序）</td>
</tr>
<tr>
<td>4</td>
<td>数据的行数（小字节序）</td>
</tr>
</tbody>
</table>
<h3 id="4-3-服务器响应报文（服务器-gt-客户端）"><a href="#4-3-服务器响应报文（服务器-gt-客户端）" class="headerlink" title="4.3 服务器响应报文（服务器 -&gt; 客户端）"></a>4.3 服务器响应报文（服务器 -&gt; 客户端）</h3><p>当客户端发起认证请求或命令请求后，服务器会返回相应的执行结果给客户端。客户端在收到响应报文后，需要首先检查第1个字节的值，来区分响应报文的类型。</p>
<table>
<thead>
<tr>
<th>响应报文类型</th>
<th>第1个字节取值范围</th>
</tr>
</thead>
<tbody>
<tr>
<td>OK 响应报文</td>
<td>0x00</td>
</tr>
<tr>
<td>Error 响应报文</td>
<td>0xFF</td>
</tr>
<tr>
<td>Result Set 报文</td>
<td>0x01 - 0xFA</td>
</tr>
<tr>
<td>Field 报文</td>
<td>0x01 - 0xFA</td>
</tr>
<tr>
<td>Row Data 报文</td>
<td>0x01 - 0xFA</td>
</tr>
<tr>
<td>EOF 报文</td>
<td>0xFE</td>
</tr>
</tbody>
</table>
<p>注：响应报文的第1个字节在不同类型中含义不同，比如在OK报文中，该字节并没有实际意义，值恒为0x00；而在Result Set报文中，该字节又是长度编码的二进制数据结构（Length Coded Binary）中的第1字节。</p>
<h4 id="4-3-1-OK-响应报文"><a href="#4-3-1-OK-响应报文" class="headerlink" title="4.3.1 OK 响应报文"></a>4.3.1 OK 响应报文</h4><p>客户端的命令执行正确时，服务器会返回OK响应报文。</p>
<p><strong>MySQL 4.0 及之前的版本</strong></p>
<table>
<thead>
<tr>
<th>字节</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>OK报文，值恒为0x00</td>
</tr>
<tr>
<td>1-9</td>
<td>受影响行数（Length Coded Binary）</td>
</tr>
<tr>
<td>1-9</td>
<td>索引ID值（Length Coded Binary）</td>
</tr>
<tr>
<td>2</td>
<td>服务器状态</td>
</tr>
<tr>
<td>n</td>
<td>服务器消息（字符串到达消息尾部时结束，无结束符）</td>
</tr>
</tbody>
</table>
<p><strong>MySQL 4.1 及之后的版本</strong></p>
<table>
<thead>
<tr>
<th>字节</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>OK报文，值恒为0x00</td>
</tr>
<tr>
<td>1-9</td>
<td>受影响行数（Length Coded Binary）</td>
</tr>
<tr>
<td>1-9</td>
<td>索引ID值（Length Coded Binary）</td>
</tr>
<tr>
<td>2</td>
<td>服务器状态</td>
</tr>
<tr>
<td>2</td>
<td>告警计数</td>
</tr>
<tr>
<td>n</td>
<td>服务器消息（字符串到达消息尾部时结束，无结束符，可选）</td>
</tr>
</tbody>
</table>
<p><strong>受影响行数</strong>：当执行<code>INSERT</code>/<code>UPDATE</code>/<code>DELETE</code>语句时所影响的数据行数。</p>
<p><strong>索引ID值</strong>：该值为<code>AUTO_INCREMENT</code>索引字段生成，如果没有索引字段，则为0x00。注意：当<code>INSERT</code>插入语句为多行数据时，该索引ID值为第一个插入的数据行索引值，而非最后一个。</p>
<p><strong>服务器状态</strong>：客户端可以通过该值检查命令是否在事务处理中。</p>
<p><strong>告警计数</strong>：告警发生的次数。</p>
<p><strong>服务器消息</strong>：服务器返回给客户端的消息，一般为简单的描述性字符串，可选字段。</p>
<h4 id="4-3-2-Error-响应报文"><a href="#4-3-2-Error-响应报文" class="headerlink" title="4.3.2 Error 响应报文"></a>4.3.2 Error 响应报文</h4><p><strong>MySQL 4.0 及之前的版本</strong></p>
<table>
<thead>
<tr>
<th>字节</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Error报文，值恒为0xFF</td>
</tr>
<tr>
<td>2</td>
<td>错误编号（小字节序）</td>
</tr>
<tr>
<td>n</td>
<td>服务器消息</td>
</tr>
</tbody>
</table>
<p><strong>MySQL 4.1 及之后的版本</strong></p>
<table>
<thead>
<tr>
<th>字节</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Error报文，值恒为0xFF</td>
</tr>
<tr>
<td>2</td>
<td>错误编号（小字节序）</td>
</tr>
<tr>
<td>1</td>
<td>服务器状态标志，恒为’#’字符</td>
</tr>
<tr>
<td>5</td>
<td>服务器状态（5个字符）</td>
</tr>
<tr>
<td>n</td>
<td>服务器消息</td>
</tr>
</tbody>
</table>
<p><strong>错误编号</strong>：错误编号值定义在源代码<code>/include/mysqld_error.h</code>头文件中。</p>
<p><strong>服务器状态</strong>：服务器将错误编号通过<code>mysql_errno_to_sqlstate</code>函数转换为状态值，状态值由5字节的ASCII字符组成，定义在源代码<code>/include/sql_state.h</code>头文件中。</p>
<p><strong>服务器消息</strong>：错误消息字符串到达消息尾时结束，长度可以由消息头中的长度值计算得出。消息长度为0-512字节。</p>
<h4 id="4-3-3-Result-Set-消息"><a href="#4-3-3-Result-Set-消息" class="headerlink" title="4.3.3 Result Set 消息"></a>4.3.3 Result Set 消息</h4><p>当客户端发送查询请求后，在没有错误的情况下，服务器会返回结果集（Result Set）给客户端。</p>
<p>Result Set 消息分为五部分，结构如下：</p>
<table>
<thead>
<tr>
<th>结构</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>[Result Set Header]</td>
<td>列数量</td>
</tr>
<tr>
<td>[Field]</td>
<td>列信息（多个）</td>
</tr>
<tr>
<td>[EOF]</td>
<td>列结束</td>
</tr>
<tr>
<td>[Row Data]</td>
<td>行数据（多个）</td>
</tr>
<tr>
<td>[EOF]</td>
<td>数据结束</td>
</tr>
</tbody>
</table>
<h4 id="4-3-4-Result-Set-Header-结构"><a href="#4-3-4-Result-Set-Header-结构" class="headerlink" title="4.3.4 Result Set Header 结构"></a>4.3.4 Result Set Header 结构</h4><table>
<thead>
<tr>
<th>字节</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>1-9</td>
<td>Field结构计数（Length Coded Binary）</td>
</tr>
<tr>
<td>1-9</td>
<td>额外信息（Length Coded Binary）</td>
</tr>
</tbody>
</table>
<p><strong>Field结构计数</strong>：用于标识Field结构的数量，取值范围0x00-0xFA。</p>
<p><strong>额外信息</strong>：可选字段，一般情况下不应该出现。只有像<code>SHOW COLUMNS</code>这种语句的执行结果才会用到额外信息（标识表格的列数量）。</p>
<h4 id="4-3-5-Field-结构"><a href="#4-3-5-Field-结构" class="headerlink" title="4.3.5 Field 结构"></a>4.3.5 Field 结构</h4><p>Field为数据表的列信息，在Result Set中，Field会连续出现多次，次数由Result Set Header结构中的IField结构计数值决定。</p>
<p><strong>MySQL 4.0 及之前的版本</strong></p>
<table>
<thead>
<tr>
<th>字节</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>n</td>
<td>数据表名称（Length Coded String）</td>
</tr>
<tr>
<td>n</td>
<td>列（字段）名称（Length Coded String）</td>
</tr>
<tr>
<td>4</td>
<td>列（字段）长度（Length Coded String）</td>
</tr>
<tr>
<td>2</td>
<td>列（字段）类型（Length Coded String）</td>
</tr>
<tr>
<td>2</td>
<td>列（字段）标志（Length Coded String）</td>
</tr>
<tr>
<td>1</td>
<td>整型值精度</td>
</tr>
<tr>
<td>n</td>
<td>默认值（Length Coded String）</td>
</tr>
</tbody>
</table>
<p><strong>MySQL 4.1 及之后的版本</strong></p>
<table>
<thead>
<tr>
<th>字节</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>n</td>
<td>目录名称（Length Coded String）</td>
</tr>
<tr>
<td>n</td>
<td>数据库名称（Length Coded String）</td>
</tr>
<tr>
<td>n</td>
<td>数据表名称（Length Coded String）</td>
</tr>
<tr>
<td>n</td>
<td>数据表原始名称（Length Coded String）</td>
</tr>
<tr>
<td>n</td>
<td>列（字段）名称（Length Coded String）</td>
</tr>
<tr>
<td>4</td>
<td>列（字段）原始名称（Length Coded String）</td>
</tr>
<tr>
<td>1</td>
<td>填充值</td>
</tr>
<tr>
<td>2</td>
<td>字符编码</td>
</tr>
<tr>
<td>4</td>
<td>列（字段）长度</td>
</tr>
<tr>
<td>1</td>
<td>列（字段）类型</td>
</tr>
<tr>
<td>2</td>
<td>列（字段）标志</td>
</tr>
<tr>
<td>1</td>
<td>整型值精度</td>
</tr>
<tr>
<td>2</td>
<td>填充值（0x00）</td>
</tr>
<tr>
<td>n</td>
<td>默认值（Length Coded String）</td>
</tr>
</tbody>
</table>
<p><strong>目录名称</strong>：在4.1及之后的版本中，该字段值为”def”。</p>
<p><strong>数据库名称</strong>：数据库名称标识。</p>
<p><strong>数据表名称</strong>：数据表的别名（<code>AS</code>之后的名称）。</p>
<p><strong>数据表原始名称</strong>：数据表的原始名称（<code>AS</code>之前的名称）。</p>
<p><strong>列（字段）名称</strong>：列（字段）的别名（<code>AS</code>之后的名称）。</p>
<p><strong>列（字段）原始名称</strong>：列（字段）的原始名称（<code>AS</code>之前的名称）。</p>
<p><strong>字符编码</strong>：列（字段）的字符编码值。</p>
<p><strong>列（字段）长度</strong>：列（字段）的长度值，真实长度可能小于该值，例如<code>VARCHAR(2)</code>类型的字段实际只能存储1个字符。</p>
<p><strong>列（字段）类型</strong>：列（字段）的类型值，取值范围如下（参考源代码<code>/include/mysql_com.h</code>头文件中的<code>enum_field_type</code>枚举类型定义）：</p>
<table>
<thead>
<tr>
<th>类型值</th>
<th>名称</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x00</td>
<td>FIELD_TYPE_DECIMAL</td>
</tr>
<tr>
<td>0x01</td>
<td>FIELD_TYPE_TINY</td>
</tr>
<tr>
<td>0x02</td>
<td>FIELD_TYPE_SHORT</td>
</tr>
<tr>
<td>0x03</td>
<td>FIELD_TYPE_LONG</td>
</tr>
<tr>
<td>0x04</td>
<td>FIELD_TYPE_FLOAT</td>
</tr>
<tr>
<td>0x05</td>
<td>FIELD_TYPE_DOUBLE</td>
</tr>
<tr>
<td>0x06</td>
<td>FIELD_TYPE_NULL</td>
</tr>
<tr>
<td>0x07</td>
<td>FIELD_TYPE_TIMESTAMP</td>
</tr>
<tr>
<td>0x08</td>
<td>FIELD_TYPE_LONGLONG</td>
</tr>
<tr>
<td>0x09</td>
<td>FIELD_TYPE_INT24</td>
</tr>
<tr>
<td>0x0A</td>
<td>FIELD_TYPE_DATE</td>
</tr>
<tr>
<td>0x0B</td>
<td>FIELD_TYPE_TIME</td>
</tr>
<tr>
<td>0x0C</td>
<td>FIELD_TYPE_DATETIME</td>
</tr>
<tr>
<td>0x0D</td>
<td>FIELD_TYPE_YEAR</td>
</tr>
<tr>
<td>0x0E</td>
<td>FIELD_TYPE_NEWDATE</td>
</tr>
<tr>
<td>0x0F</td>
<td>FIELD_TYPE_VARCHAR (new in MySQL 5.0)</td>
</tr>
<tr>
<td>0x10</td>
<td>FIELD_TYPE_BIT (new in MySQL 5.0)</td>
</tr>
<tr>
<td>0xF6</td>
<td>FIELD_TYPE_NEWDECIMAL (new in MYSQL 5.0)</td>
</tr>
<tr>
<td>0xF7</td>
<td>FIELD_TYPE_ENUM</td>
</tr>
<tr>
<td>0xF8</td>
<td>FIELD_TYPE_SET</td>
</tr>
<tr>
<td>0xF9</td>
<td>FIELD_TYPE_TINY_BLOB</td>
</tr>
<tr>
<td>0xFA</td>
<td>FIELD_TYPE_MEDIUM_BLOB</td>
</tr>
<tr>
<td>0xFB</td>
<td>FIELD_TYPE_LONG_BLOB</td>
</tr>
<tr>
<td>0xFC</td>
<td>FIELD_TYPE_BLOB</td>
</tr>
<tr>
<td>0xFD</td>
<td>FIELD_TYPE_VAR_STRING</td>
</tr>
<tr>
<td>0xFE</td>
<td>FIELD_TYPE_STRING</td>
</tr>
<tr>
<td>0xFF</td>
<td>FIELD_TYPE_GEOMETRY</td>
</tr>
</tbody>
</table>
<p><strong>列（字段）标志</strong>：各标志位定义如下（参考源代码<code>/include/mysql_com.h</code>头文件中的宏定义）：</p>
<table>
<thead>
<tr>
<th>标志位</th>
<th>名称</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x0001</td>
<td>NOT_NULL_FLAG</td>
</tr>
<tr>
<td>0x0002</td>
<td>PRI_KEY_FLAG</td>
</tr>
<tr>
<td>0x0004</td>
<td>UNIQUE_KEY_FLAG</td>
</tr>
<tr>
<td>0x0008</td>
<td>MULTIPLE_KEY_FLAG</td>
</tr>
<tr>
<td>0x0010</td>
<td>BLOB_FLAG</td>
</tr>
<tr>
<td>0x0020</td>
<td>UNSIGNED_FLAG</td>
</tr>
<tr>
<td>0x0040</td>
<td>ZEROFILL_FLAG</td>
</tr>
<tr>
<td>0x0080</td>
<td>BINARY_FLAG</td>
</tr>
<tr>
<td>0x0100</td>
<td>ENUM_FLAG</td>
</tr>
<tr>
<td>0x0200</td>
<td>AUTO_INCREMENT_FLAG</td>
</tr>
<tr>
<td>0x0400</td>
<td>TIMESTAMP_FLAG</td>
</tr>
<tr>
<td>0x0800</td>
<td>SET_FLAG</td>
</tr>
</tbody>
</table>
<p><strong>数值精度</strong>：该字段对<code>DECIMAL</code>和<code>NUMERIC</code>类型的数值字段有效，用于标识数值的精度（小数点位置）。</p>
<p><strong>默认值</strong>：该字段用在数据表定义中，普通的查询结果中不会出现。</p>
<p><strong>附</strong>：Field结构的相关处理函数：</p>
<ul>
<li>客户端：<code>/client/client.c</code>源文件中的<code>unpack_fields</code>函数</li>
<li>服务器：<code>/sql/sql_base.cc</code>源文件中的<code>send_fields</code>函数</li>
</ul>
<h4 id="4-3-6-EOF-结构"><a href="#4-3-6-EOF-结构" class="headerlink" title="4.3.6 EOF 结构"></a>4.3.6 EOF 结构</h4><p>EOF结构用于标识Field和Row Data的结束，在预处理语句中，EOF也被用来标识参数的结束。</p>
<p><strong>MySQL 4.0 及之前的版本</strong></p>
<table>
<thead>
<tr>
<th>字节</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>EOF值（0xFE）</td>
</tr>
</tbody>
</table>
<p><strong>MySQL 4.1 及之后的版本</strong></p>
<table>
<thead>
<tr>
<th>字节</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>EOF值（0xFE）</td>
</tr>
<tr>
<td>2</td>
<td>告警计数</td>
</tr>
<tr>
<td>2</td>
<td>状态标志位</td>
</tr>
</tbody>
</table>
<p><strong>告警计数</strong>：服务器告警数量，在所有数据都发送给客户端后该值才有效。</p>
<p><strong>状态标志位</strong>：包含类似<code>SERVER_MORE_RESULTS_EXISTS</code>这样的标志位。</p>
<p><strong>注</strong>：由于EOF值与其它Result Set结构共用1字节，所以在收到报文后需要对EOF包的真实性进行校验，校验条件为：</p>
<ul>
<li>第1字节值为0xFE</li>
<li>包长度小于9字节</li>
</ul>
<p><strong>附</strong>：EOF结构的相关处理函数：</p>
<ul>
<li>服务器：<code>protocol.cc</code>源文件中的<code>send_eof</code>函数</li>
</ul>
<h4 id="4-3-7-Row-Data-结构"><a href="#4-3-7-Row-Data-结构" class="headerlink" title="4.3.7 Row Data 结构"></a>4.3.7 Row Data 结构</h4><p>在Result Set消息中，会包含多个Row Data结构，每个Row Data结构又包含多个字段值，这些字段值组成一行数据。</p>
<table>
<thead>
<tr>
<th>字节</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>n</td>
<td>字段值（Length Coded String）</td>
</tr>
<tr>
<td>…</td>
<td>（一行数据中包含多个字段值）</td>
</tr>
</tbody>
</table>
<p><strong>字段值</strong>：行数据中的字段值，字符串形式。</p>
<p><strong>附</strong>：Row Data结构的相关处理函数：</p>
<ul>
<li>客户端：<code>/client/client.c</code>源文件中的<code>read_rows</code>函数</li>
</ul>
<h4 id="4-3-8-Row-Data-结构（二进制数据）"><a href="#4-3-8-Row-Data-结构（二进制数据）" class="headerlink" title="4.3.8 Row Data 结构（二进制数据）"></a>4.3.8 Row Data 结构（二进制数据）</h4><p>该结构用于传输二进制的字段值，既可以是服务器返回的结果，也可以是由客户端发送的（当执行预处理语句时，客户端使用Result Set消息来发送参数及数据）。</p>
<table>
<thead>
<tr>
<th>字节</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>结构头（0x00）</td>
</tr>
<tr>
<td>(列数量 + 7 + 2) / 8</td>
<td>空位图</td>
</tr>
<tr>
<td>n</td>
<td>字段值</td>
</tr>
<tr>
<td>…</td>
<td>（一行数据中包含多个字段值）</td>
</tr>
</tbody>
</table>
<p><strong>空位图</strong>：前2个比特位被保留，值分别为0和1，以保证不会和OK、Error包的首字节冲突。在MySQL 5.0及之后的版本中，这2个比特位的值都为0。</p>
<p><strong>字段值</strong>：行数据中的字段值，二进制形式。</p>
<h4 id="4-3-9-PREPARE-OK-响应报文（Prepared-Statement）"><a href="#4-3-9-PREPARE-OK-响应报文（Prepared-Statement）" class="headerlink" title="4.3.9 PREPARE_OK 响应报文（Prepared Statement）"></a>4.3.9 PREPARE_OK 响应报文（Prepared Statement）</h4><p>用于响应客户端发起的预处理语句报文，组成结构如下：</p>
<table>
<thead>
<tr>
<th>结构</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>[PREPARE_OK]</td>
<td>PREPARE_OK结构</td>
</tr>
<tr>
<td>如果参数数量大于0</td>
<td></td>
</tr>
<tr>
<td>[Field]</td>
<td>与Result Set消息结构相同</td>
</tr>
<tr>
<td>[EOF]</td>
<td></td>
</tr>
<tr>
<td>如果列数大于0</td>
<td></td>
</tr>
<tr>
<td>[Field]</td>
<td>与Result Set消息结构相同</td>
</tr>
<tr>
<td>[EOF]</td>
</tr>
</tbody>
</table>
<p>其中 PREPARD_OK 的结构如下：</p>
<table>
<thead>
<tr>
<th>字节</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>OK报文，值为0x00</td>
</tr>
<tr>
<td>4</td>
<td>预处理语句ID值</td>
</tr>
<tr>
<td>2</td>
<td>列数量</td>
</tr>
<tr>
<td>2</td>
<td>参数数量</td>
</tr>
<tr>
<td>1</td>
<td>填充值（0x00）</td>
</tr>
<tr>
<td>2</td>
<td>告警计数</td>
</tr>
</tbody>
</table>
<h4 id="4-3-10-Parameter-响应报文（Prepared-Statement）"><a href="#4-3-10-Parameter-响应报文（Prepared-Statement）" class="headerlink" title="4.3.10 Parameter 响应报文（Prepared Statement）"></a>4.3.10 Parameter 响应报文（Prepared Statement）</h4><p>预处理语句的值与参数正确对应后，服务器会返回 Parameter 报文。</p>
<table>
<thead>
<tr>
<th>字节</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>2</td>
<td>类型</td>
</tr>
<tr>
<td>2</td>
<td>标志</td>
</tr>
<tr>
<td>1</td>
<td>数值精度</td>
</tr>
<tr>
<td>4</td>
<td>字段长度</td>
</tr>
</tbody>
</table>
<p><strong>类型</strong>：与 Field 结构中的字段类型相同。</p>
<p><strong>标志</strong>：与 Field 结构中的字段标志相同。</p>
<p><strong>数值精度</strong>：与 Field 结构中的数值精度相同。</p>
<p><strong>字段长度</strong>：与 Field 结构中的字段长度相同。</p>
<h2 id="5-参考资料"><a href="#5-参考资料" class="headerlink" title="5 参考资料"></a>5 参考资料</h2><p>《<a href="http://dev.mysql.com/doc/internals/en/index.html" target="_blank" rel="noopener">MySQL Internals Manual</a>: <a href="http://dev.mysql.com/doc/internals/en/client-server-protocol.html" target="_blank" rel="noopener">MySQL Client/Server Protocol</a>》</p>
<h2 id="来源"><a href="#来源" class="headerlink" title="来源"></a>来源</h2><p><a href="http://hutaow.com/blog/2013/11/06/mysql-protocol-analysis/" target="_blank" rel="noopener">http://hutaow.com/blog/2013/11/06/mysql-protocol-analysis/</a></p>

        </div>

        <blockquote class="post-copyright">
    <div class="content">
        
<span class="post-time">
    最終更新：<time datetime="2018-05-15T08:14:14.861Z" itemprop="dateUpdated">2018-05-15 16:14:14</time>
</span><br>


        
        <a href="/2018/05/15/mysql-protocol/" target="_blank" rel="external">http://www.twosee.cn/2018/05/15/mysql-protocol/</a>
        
    </div>
    <footer>
        <a href="http://www.twosee.cn">
            <img src="https://avatars2.githubusercontent.com/u/25978241?s=460&v=4" alt="Twosee">
            Twosee
        </a>
    </footer>
</blockquote>

        
<div class="page-reward">
    <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-circle waves-light">赏</a>
</div>



        <div class="post-footer">
            
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mysql/">mysql</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://www.twosee.cn/2018/05/15/mysql-protocol/&title=《[整理] MySQL协议分析》 — TWO SEE&pic=https://avatars2.githubusercontent.com/u/25978241?s=460&v=4" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://www.twosee.cn/2018/05/15/mysql-protocol/&title=《[整理] MySQL协议分析》 — TWO SEE&source=目录[TOC]
1 交互过程MySQL客户端与服务器的交互主要分为两个阶段：握手认证阶段和命令执行阶段。
1.1 握手认证阶段握手认证阶段为客户端与服务器..." data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://www.twosee.cn/2018/05/15/mysql-protocol/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《[整理] MySQL协议分析》 — TWO SEE&url=http://www.twosee.cn/2018/05/15/mysql-protocol/&via=http://www.twosee.cn" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://www.twosee.cn/2018/05/15/mysql-protocol/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/2018/05/21/coroutine-boil-water/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">并发,协程与烧开水问题</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/2018/05/12/mysql-status-check/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">[整理]MySQL查看连接数以及状态</h4>
      </a>
    </div>
  
</nav>



    














</article>

<div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        谢谢~
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardCode" src="/img/wechat.jpg" alt="打赏二维码">
        </div>
        
        <label class="reward-toggle">
            <input id="rewardToggle" type="checkbox" class="reward-toggle-check"
                data-wechat="/img/wechat.jpg" data-alipay="/img/alipay.jpg">
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">微信</span>
                <span class="reward-toggle-label"></span>
                <span class="reward-toggle-item alipay">支付宝</span>
            </div>
        </label>
        
    </div>
</div>



</div>

        <footer class="footer">
    <div class="top">
        
<p>
    <span id="busuanzi_container_site_uv" style='display:none'>
        站点总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style='display:none'>
        站点总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


        <p>
            
                <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span>
            
            <span>このブログの内容物は<a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.ja">クリエイティブ・コモンズ 表示 - 非営利 - 継承 4.0 国際ライセンスの下に提供されています</a></span>
        </p>
    </div>
    <div class="bottom">
        <p><span>Twosee &copy; 2003 - 2018</span>
            <span>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://www.twosee.cn/2018/05/15/mysql-protocol/&title=《[整理] MySQL协议分析》 — TWO SEE&pic=https://avatars2.githubusercontent.com/u/25978241?s=460&v=4" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://www.twosee.cn/2018/05/15/mysql-protocol/&title=《[整理] MySQL协议分析》 — TWO SEE&source=目录[TOC]
1 交互过程MySQL客户端与服务器的交互主要分为两个阶段：握手认证阶段和命令执行阶段。
1.1 握手认证阶段握手认证阶段为客户端与服务器..." data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://www.twosee.cn/2018/05/15/mysql-protocol/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《[整理] MySQL协议分析》 — TWO SEE&url=http://www.twosee.cn/2018/05/15/mysql-protocol/&via=http://www.twosee.cn" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://www.twosee.cn/2018/05/15/mysql-protocol/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACKElEQVR42u3a0WrDMAwF0P3/T2evgy3ZlZQUYh8/hbbEPi4IS/LXVzyOHyP59jgZZ98ms9wwMDAwXss4LkeV8fs3v99z9pxvxx8rwcDA2IBxtrjrKSe/zwP39dowMDAwqowkOF4vFwMDA+MzATc5OOafYGBgYORJbLXGNSnPPZiLY2BgvJCRV90///xIfwMDA+NVjKM4JkfJB1eFgYGxNCOfppeIzo+GhcsfGBgYGzB6U55tRFL6Twp2hZQVAwNjUUZ+/SspgfVCdvL+ayQGBsbajCTMVdPRJ1LWaC4MDIylGXkYzVPZ5HhXvToWbRMGBsYGjOeuUOTJbXVzMTAw1mZUC/S9aZKi26TBgIGBsTbjrgZAErjzQ2RyEGwGXwwMjNcy5glkXmLrhebC/4CBgbEcI0lTq9cm8tQ3bzxEzUsMDIwNGJNwOdmCR+6MYGBgLM3olcOq9flqa6GwuxgYGMsxemWyu2C9xLjZicXAwFiIkZfYqs2DvMQ2SXcxMDBWZVSPX5NEdNIK/ad5gIGBsQFjkoJWj4x3hfsbaoEYGBivZeRJbH4EvKusFp1tMTAwFmIcxTEJoDk7CfSFOyMYGBgvZ1QT116xLA/ZvSQZAwNjB0YeZKsNg88kzxgYGPsw8sCXLLp3lJy0JTAwMDDyKxHJJ+X2ZLKtGBgYGEFq2py+1Qw4TWIxMDCWZvRamHmJLS/JNct/GBgYSzMmIW/etpwsHQMDYwPGN2PKapgUzgolAAAAAElFTkSuQmCC" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: true };


</script>

<script src="/js/main.min.js?v=1.7.1"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="/js/search.min.js?v=1.7.1" async></script>






<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
